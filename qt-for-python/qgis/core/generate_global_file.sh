#!/bin/bash

SCRIPT_DIR=$(dirname $(readlink -f "$0"))

FILE=$SCRIPT_DIR/qgis_core_global.h
echo "// Generated by the ugly script generate_global_file.sh" >> $FILE
echo "#pragma once" > $FILE

echo "// Make \"signals:\", \"slots:\" visible as access specifiers" >> $FILE
echo "#define QT_ANNOTATE_ACCESS_SPECIFIER(a) __attribute__((annotate(#a)))"  >> $FILE

pushd $SCRIPT_DIR/../../../src/core > /dev/null

mkdir -p $SCRIPT_DIR/typesystems

TYPESYSTEM_FILE="$SCRIPT_DIR/typesystems/typesystem_all.xml"
echo "<?xml version=\"1.0\"?>" >> $TYPESYSTEM_FILE
echo "<!-- Generated by the ugly script generate_global_file.sh -->" > $TYPESYSTEM_FILE
echo "<typesystem package=\"core\">" >> $TYPESYSTEM_FILE


for hdr in $(find . -name "*.h" | grep -v _p);
do
  if [[ $(grep "SIP_NO_FILE" $hdr | wc -l) -gt 0 ]];
  then
    continue
  fi

  hdr_str=$(echo $hdr | sed "s/\.\///")
  echo "#include <$hdr_str>"  >> $FILE

  typesystem_file=$(basename "${hdr%.*}".xml)
  typesystem_filepath=$SCRIPT_DIR/typesystems/$typesystem_file

  if [[ ! -f $typesystem_filepath ]]
  then
    echo "Generating $typesystem_file ..."
    /home/julien/work/pyside-setup/build/sources/shiboken6/tests/dumpcodemodel/dumpcodemodel -- -DQT_CONCURRENT_LIB -DQT_CORE5COMPAT_LIB -DQT_CORE_LIB -DQT_DEPRECATED_WARNINGS -DQT_DISABLE_DEPRECATED_BEFORE=0x050800 -DQT_GUI_LIB -DQT_NETWORK_LIB -DQT_NO_CAST_TO_ASCII -DQT_NO_FOREACH -DQT_POSITIONING_LIB -DQT_PRINTSUPPORT_LIB -DQT_SERIALPORT_LIB -DQT_SQL_LIB -DQT_SVG_LIB -DQT_USE_QSTRINGBUILDER -DQT_WIDGETS_LIB -DQT_XML_LIB -DTEST_DATA_DIR="/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/tests/testdata" -DWITH_COPC -DWITH_EPT -D_HAVE_PTHREAD_ -Dqgis_core_EXPORTS -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/build/src/core/qgis_core_autogen/include -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/build -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/external/poly2tri -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/providers/ept -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/providers/copc -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/providers/vpc -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/build/src/core -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/3d -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/actions -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/annotations -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/auth -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/browser -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/callouts -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/classification -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/diagram -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/dxf -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/editform -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/effects -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/elevation -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/expression -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/externalstorage -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/fieldformatter -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/geometry -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/geocoding -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/gps -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/labeling -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/layertree -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/layout -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/locator -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/maprenderer -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/mesh -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/metadata -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/network -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/numericformats -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/pal -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/plot -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/pointcloud -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/pointcloud/expression -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/processing -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/processing/models -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/proj -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/project -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/providers -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/providers/arcgis -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/providers/memory -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/providers/gdal -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/providers/ogr -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/providers/meshmemory -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/raster -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/renderer -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/scalebar -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/settings -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/sensor -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/symbology -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/textrenderer -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/validity -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/vector -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/src/core/vectortile -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/external -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/external/nlohmann -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/external/kdbush/include -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/external/nmea -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/external/rtree/include -I/home/julien/work/QGIS/.worktrees/qt-for-python-qt6/external/meshOptimizer -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/include/QtCore -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/include -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/include/QtGui -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/include/QtDBus -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/include/QtXml -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/include/QtWidgets -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/include/QtSvg -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/include/QtPrintSupport -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/include/QtNetwork -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/include/QtSql -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/include/QtConcurrent -isystem /usr/include/gdal -isystem /home/julien/work/depends/qca-2.3.5/install/include/Qca-qt6/QtCrypto -isystem /home/julien/work/depends/qtkeychain-0.13.2/install/include/qt6keychain -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/include/QtSerialPort -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/mkspecs/linux-g++ -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/include/QtCore5Compat -isystem /home/julien/work/depends/Qt/6.5.0/gcc_64/include/QtPositioning  -Wall -Wextra -Wno-long-long -Wformat-security -Wno-strict-aliasing -Wnon-virtual-dtor -Wno-redundant-move -Wno-misleading-indentation -Wno-deprecated-copy -g -fPIC -fvisibility=hidden -fPIC -std=gnu++17 $hdr > $typesystem_filepath 2> /dev/null
    [[ $? -ne 0 ]] && echo "Error while generating file: $typesystem_file" && exit
  fi

  echo "<load-typesystem name=\"$(basename $typesystem_file)\" generate=\"yes\"/>" >> $TYPESYSTEM_FILE

done

#parallel --ungroup --jobs 3 /home/julien/work/pyside-setup/build/sources/shiboken6/tests/dumpcodemodel/dumpcodemodel ::: 1 2 3 4 5 6

echo "</typesystem>" >> $TYPESYSTEM_FILE

popd  > /dev/null
